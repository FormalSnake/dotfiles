set  -g default-terminal "tmux-256color"
set  -g base-index      1
setw -g pane-base-index 1


set -g status-keys vi
set -g mode-keys   vi


set  -g mouse             on
set  -g focus-events      on
setw -g aggressive-resize off
setw -g clock-mode-style  12
set  -s escape-time       0
set  -g history-limit     50000

# ============================================= #
# TPM Plugin Manager                            #
# --------------------------------------------- #

# List of plugins
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @plugin 'christoomey/vim-tmux-navigator'
set -g @plugin 'sainnhe/tmux-fzf'

# Plugin configurations
# ---------------------

# tmux-resurrect
set -g @resurrect-strategy-nvim 'session'
set -g @resurrect-capture-pane-contents 'on'
set -g @resurrect-save-bash-history 'on'

# tmux-continuum
set -g @continuum-restore 'on'
set -g @continuum-save-interval '15'
set -g @continuum-boot 'on'

# tmux-fzf
set -g @fzf-url-launch-key 'C-f'
TMUX_FZF_LAUNCH_KEY="C-f"
TMUX_FZF_ORDER="session|window|pane|command|keybinding|clipboard|process"
TMUX_FZF_ACTION_ORDER="switch|attach|rename|kill"

# ============================================= #

# Image protocol support (kitty/ghostty)
set -gq allow-passthrough on
set -g visual-activity off

# Ensure passthrough for nested sessions
set -g allow-passthrough all

# Terminal capabilities and true color
set-option -sa terminal-overrides ",xterm*:Tc"
set-option -sa terminal-overrides '*:Ss=\E[%p1%d q:Se=\E[2 q'
set-option -ga terminal-overrides '*:Tc'
set-option -ga terminal-overrides '*:sitm=\E[3m'
set-option -sa terminal-features ',xterm-ghostty:RGB'

# Ghostty specific overrides for image protocol
set-option -ga terminal-overrides ',xterm-ghostty:Tc'
set-option -ga terminal-overrides ',xterm-ghostty:Ms=\\E]52;%p1%s;%p2%s\\007'
set-option -ga terminal-overrides ',xterm-ghostty:Sync'
set-option -g focus-events on

# Window title support
set-option -g set-titles on
set-option -g set-titles-string "#T"

# Performance optimizations
set -s escape-time 0
set -g display-time 1000
set -g status-interval 5
set -g automatic-rename on
set -g automatic-rename-format '#{b:pane_current_path}'

# Window and pane indexing
set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on

# Theme loading will happen after TPM initialization

# Status bar configuration (after theme loading)
set -g status on
set -g status-position bottom
set -g status-justify left

# Shortcuts
bind r source-file ~/.config/tmux/tmux.conf \; display-message "Config reloaded!"

# Initialize TPM
run '~/.tmux/plugins/tpm/tpm'

# Load theme configuration after TPM loads plugins
# Check if symlink exists and source the theme, fallback to tokyo-night if not found
if-shell '[ -f ~/.config/formalconf/current/theme/tmux.theme ]' \
  'source ~/.config/formalconf/current/theme/tmux.theme' \
  'source ~/.config/tmux/themes/tokyo-night.conf'
